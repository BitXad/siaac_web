<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Tarea_model extends CI_Model
{
    function __construct()
    {
        parent::__construct();
    }

    /*
    * Obtener todas las tareas
    */
    function get_all_tareas($docente_id, $materia_id){
        $tareas = $this->db->query(
            "SELECT t.*, e.`estado_descripcion`
            FROM tarea AS t
            LEFT JOIN horario AS h ON h.`docente_id` = t.`docente_id`
            LEFT JOIN grupo AS g ON g.`grupo_id` = h.`grupo_id`
            LEFT JOIN materia AS m ON m.materia_id =  t.`materia_id`
            LEFT JOIN estado AS e ON e.`estado_id` = t.`estado_id`
            WHERE t.`docente_id` = $docente_id
            AND t.`materia_id` = $materia_id
            GROUP BY t.`tarea_id`"
        )->result_array();
        return $tareas;
    }

    /*
    * Agregar una nueva tarea a una materia
    */
    function add_tarea($params){
        $this->db->insert('tarea',$params);
        return $this->db->insert_id();
    }

    /*
    * Actualizar tarea 
    */
    function update_tarea($tarea_id, $params){
        $this->db->where('tarea_id',$tarea_id);
        return $this->db->update('tarea',$params);
    }

    /*
    * Buscar tarea 
    */
    function get_tarea($tarea_id){
        $tarea = $this->db->query(
            "SELECT * FROM tarea WHERE tarea_id = $tarea_id"
        )->row_array();
        return $tarea;
    }

    /*
    * Obtener todas las tareas activas por el nivel que estudiante
    */
    function get_tareas($estudiante_id){
        $tareas = $this->db->query(
            "SELECT t.*, m.materia_nombre, d.`docente_nombre`, d.`docente_apellidos`,if(count(r.tarea_id) > 0, 1, 0) AS respondido
            FROM inscripcion as i
            LEFT JOIN kardex_academico AS ka ON i.`inscripcion_id` = ka.`inscripcion_id`
            LEFT JOIN materia_asignada AS ma ON ka.`kardexacad_id` = ma.`kardexacad_id`
            LEFT JOIN horario AS h ON h.`grupo_id` = ma.`grupo_id`
            LEFT JOIN tarea AS t ON t.`docente_id` = h.`docente_id`
            LEFT JOIN materia AS m ON t.`materia_id` =  m.materia_id
            LEFT JOIN docente AS d ON d.`docente_id` = h.`docente_id`
            LEFT JOIN (
              select res.* 
              from respuesta res
              where res.estudiante_id = $estudiante_id
            ) r ON (r.tarea_id = t.tarea_id)
            WHERE i.`estudiante_id` = $estudiante_id
            AND t.`estado_id` = 1
            GROUP BY t.`tarea_id`"
        )->result_array();
        return $tareas;
    }
    /*
    * Obtener tarea de estudiante 
    */
    function get_tarea_estudiante($tarea_id){
        return $this->db->query(
            "select t.*, e.`estado_descripcion`
            from tarea as t
            left join estado as e on e.`estado_id` = t.`estado_id`
            where t.tarea_id = $tarea_id
            ")->row_array();
    }
}